<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#111827">
    <title>AfroPerm | Professional Tool</title>
    
    <!-- VK Bridge SDK -->
    <script src="https://unpkg.com/@vkontakte/vk-bridge/dist/browser.min.js"></script>

    <!-- PWA Manifest - Updated according to recommendation -->
    <link rel="manifest" href="manifest.json">
    <link rel="icon" href="icon.svg" type="image/svg+xml">

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100;200;300;400;500;600&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --charcoal: #111827;
            --soft-gray: #9CA3AF;
            --border: #E5E7EB;
        }

        body {
            font-family: 'Inter', -apple-system, sans-serif;
            background-color: #FFFFFF;
            color: var(--charcoal);
            -webkit-font-smoothing: antialiased;
            margin: 0;
            padding: 0;
            overflow-x: hidden;
            -webkit-tap-highlight-color: transparent;
        }

        #splatterCanvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 999;
        }

        .sticky-header {
            position: sticky;
            top: 0;
            z-index: 50;
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(15px);
            border-bottom: 1px solid var(--border);
            padding: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header-title {
            letter-spacing: 0.5em;
            text-transform: uppercase;
            font-weight: 600;
            font-size: 0.7rem;
        }

        .info-btn {
            font-size: 0.65rem;
            letter-spacing: 0.1em;
            text-transform: uppercase;
            border: 1px solid var(--charcoal);
            padding: 0.4rem 0.8rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .main-container {
            max-width: 600px;
            margin: 0 auto;
            padding: 2rem 1.5rem 14rem;
        }

        .section-label {
            letter-spacing: 0.25em;
            text-transform: uppercase;
            font-size: 0.6rem;
            font-weight: 600;
            color: var(--soft-gray);
            margin-bottom: 1.5rem;
            display: block;
        }

        .input-group {
            border-bottom: 1px solid var(--border);
            padding-bottom: 2rem;
            margin-bottom: 2rem;
        }

        .service-selector {
            display: flex;
            gap: 1px;
            background: var(--border);
            border: 1px solid var(--border);
            margin-bottom: 3rem;
        }

        .service-option {
            flex: 1;
            background: #FFF;
            padding: 1rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
            text-transform: uppercase;
            font-size: 0.65rem;
            letter-spacing: 0.15em;
            font-weight: 500;
        }

        .service-option.active {
            background: var(--charcoal);
            color: #FFF;
        }

        input[type="range"] {
            -webkit-appearance: none;
            width: 100%;
            height: 1px;
            background: var(--border);
            outline: none;
            margin: 1.5rem 0;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 24px;
            height: 24px;
            background: #FFFFFF;
            border: 1px solid var(--charcoal);
            border-radius: 50%;
            cursor: pointer;
        }

        .display-value {
            font-weight: 200;
            font-size: 3.5rem;
            line-height: 1;
            letter-spacing: -0.02em;
        }

        .unit {
            font-size: 0.9rem;
            color: var(--soft-gray);
            margin-left: 0.5rem;
            font-weight: 300;
        }

        .custom-checkbox {
            display: flex;
            align-items: center;
            cursor: pointer;
            padding: 0.75rem 0;
        }

        .custom-checkbox input { display: none; }

        .checkmark {
            width: 20px;
            height: 20px;
            border: 1px solid var(--charcoal);
            margin-right: 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .custom-checkbox input:checked + .checkmark { background: var(--charcoal); }
        .custom-checkbox input:checked + .checkmark::after {
            content: '';
            width: 6px;
            height: 6px;
            background: white;
        }

        .sub-control {
            max-height: 0;
            overflow: hidden;
            padding-left: 2rem;
            border-left: 1px solid var(--border);
            opacity: 0;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .sub-control.active {
            max-height: 600px;
            opacity: 1;
            margin-top: 1rem;
            margin-bottom: 2rem;
        }

        .result-panel {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: #FFFFFF;
            border-top: 1px solid var(--charcoal);
            padding: 2rem 1.5rem calc(2rem + env(safe-area-inset-bottom));
            max-width: 600px;
            margin: 0 auto;
            z-index: 40;
        }

        .price-display {
            font-weight: 100;
            font-size: 4rem;
            letter-spacing: -0.05em;
            line-height: 1;
        }

        #modalOverlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.98);
            z-index: 100;
            display: none;
            overflow-y: auto;
            padding: 2rem 1rem;
        }

        .modal-content {
            max-width: 600px;
            margin: 0 auto;
        }

        .price-table {
            width: 100%;
            border-collapse: collapse;
            margin: 1.5rem 0 3rem;
            font-size: 0.8rem;
        }

        .price-table th, .price-table td {
            text-align: left;
            padding: 1rem 0;
            border-bottom: 1px solid var(--border);
        }

        .price-table th {
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: var(--soft-gray);
            font-weight: 600;
        }

        .info-block {
            margin-bottom: 2.5rem;
            line-height: 1.6;
            font-size: 0.85rem;
        }

        .info-block h3 {
            text-transform: uppercase;
            letter-spacing: 0.15em;
            font-size: 0.7rem;
            font-weight: 600;
            margin-bottom: 1rem;
        }

        .contact-info {
            background: #F9FAFB;
            padding: 2rem;
            margin-top: 3rem;
            font-size: 0.8rem;
        }

        .hidden-element { display: none !important; }
    </style>
</head>
<body>

    <canvas id="splatterCanvas"></canvas>

    <header class="sticky-header">
        <div class="header-title">AfroPerm Studio</div>
        <div class="info-btn" onclick="toggleModal(true)">Прайс & Инфо</div>
    </header>

    <!-- Модальное окно -->
    <div id="modalOverlay">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-10">
                <span class="section-label" style="margin-bottom:0">Цены и Информация</span>
                <button onclick="toggleModal(false)" class="text-3xl font-light p-2">&times;</button>
            </div>

            <div class="info-block">
                <p class="text-sm font-light text-gray-500 italic">Для понимания: итоговая стоимость зависит от количества изготовленных дредов. Количество же зависит от качества ваших волос и желаемого результата — желаемой толщины дреда.</p>
            </div>

            <div class="info-block">
                <h3>01. Стоимость плетения</h3>
                <table class="price-table">
                    <thead>
                        <tr><th>Длина</th><th>Цена за шт.</th></tr>
                    </thead>
                    <tbody>
                        <tr><td>до 10 см</td><td>300 ₽</td></tr>
                        <tr><td>до 20 см</td><td>500 ₽</td></tr>
                        <tr><td>до 30 см</td><td>700 ₽</td></tr>
                        <tr><td>до 40 см</td><td>900 ₽</td></tr>
                        <tr><td>каждые +10 см</td><td>+200 ₽</td></tr>
                    </tbody>
                </table>
            </div>

            <div class="info-block">
                <h3>02. Дополнительные услуги</h3>
                <table class="price-table">
                    <tbody>
                        <tr><td>Коррекция (база)</td><td>150 ₽ / шт.</td></tr>
                        <tr><td>Оформление кончика</td><td>50 ₽ / шт.</td></tr>
                        <tr><td>Сращивание (удлинение)</td><td>50 ₽ / шт.</td></tr>
                        <tr><td>Коррекция длины</td><td>50 ₽ / 10 см</td></tr>
                        <tr><td>Прикорневое валяние</td><td>30 ₽ / шт.</td></tr>
                        <tr><td>Капучино</td><td>Ваша улыбка :)</td></tr>
                    </tbody>
                </table>
            </div>

            <div class="info-block">
                <h3>03. Рекомендации по количеству</h3>
                <div class="space-y-4 font-light text-gray-700">
                    <p><strong>Толстые дреды (40-60 штук):</strong> подходит только для густых волос. На среднюю густоту 45-55 / густые 50-60.</p>
                    <p><strong>Чуть толще стандарта (60-80 штук):</strong> на не густые 60-70 / на среднюю густоту 65-75 / на густые где то 70-80 штук.</p>
                    <p><strong>Стандартной толщины (80-100 штук):</strong> на не густые 80-90 / на среднюю густоту 85-95 / на густые 90-100.</p>
                    <p><strong>Тонкие дреды:</strong> больше 100 штук на все типы волос.</p>
                </div>
            </div>

            <div class="info-block">
                <h3>04. Особенности зон</h3>
                <p class="font-light text-gray-700">Зона андерката составляет примерно половину (1/2) от всего количества изготовления дредов на всю голову. Не заплетенная челка составляет примерно 1/5 от общего количества.</p>
            </div>

            <div class="info-block">
                <h3>05. От чего зависит потеря длины</h3>
                <ul class="list-disc pl-5 font-light text-gray-700 space-y-1">
                    <li>длины волос (чем длиннее волосы, тем больше уходит длина)</li>
                    <li>их качества (чем равномернее длина, тем они лучше сохраниться)</li>
                    <li>желаемой толщины дредов (чем они толще, тем сильнее уходит длина)</li>
                    <li>вид кончика (заправленный съедает больше длины)</li>
                </ul>
            </div>

            <div class="contact-info">
                <p class="font-semibold mb-2 uppercase tracking-widest text-[0.7rem]">Контакты</p>
                <p>Пермь, Николая Островского 60, 2 этаж, офис 206а</p>
                <p class="mt-2">Тел: <a href="tel:+79223503162" class="underline font-medium">+7 (922) 350-31-62</a></p>
                <p class="mt-1">ВК: <a href="https://vk.ru/afro_perm" target="_blank" class="underline font-medium">vk.ru/afro_perm</a></p>
            </div>

            <button onclick="toggleModal(false)" class="w-full mt-10 border border-black p-5 uppercase tracking-widest text-xs font-bold bg-black text-white hover:opacity-90 transition-all">Закрыть</button>
        </div>
    </div>

    <main class="main-container">
        <span class="section-label">00. Тип услуги</span>
        <div class="service-selector">
            <div id="typeCreation" class="service-option active" onclick="setService('creation', event)">Плетение</div>
            <div id="typeCorrection" class="service-option" onclick="setService('correction', event)">Коррекция</div>
        </div>

        <div class="input-group">
            <span id="mainCountLabel" class="section-label">01. Общее количество</span>
            <div class="flex items-baseline">
                <span id="countVal" class="display-value">50</span>
                <span class="unit">шт</span>
            </div>
            <input type="range" id="countRange" min="0" max="150" value="50">
        </div>

        <div id="groupLength" class="input-group">
            <span class="section-label">02. Длина</span>
            <div class="flex items-baseline">
                <span id="lengthVal" class="display-value">10</span>
                <span class="unit">см</span>
            </div>
            <input type="range" id="lengthRange" min="5" max="100" value="10">
        </div>

        <div id="groupAddons" class="input-group" style="border-bottom: none;">
            <span class="section-label">03. Дополнительно</span>
            
            <label class="custom-checkbox" onclick="triggerSplatter(event)">
                <input type="checkbox" id="bluntEndToggle">
                <span class="checkmark"></span>
                <span class="checkbox-label uppercase tracking-widest text-[0.65rem] font-bold">Тупой кончик (+50₽/шт)</span>
            </label>
            <div id="bluntEndControl" class="sub-control">
                <div class="flex items-baseline mt-2">
                    <span id="bluntCountVal" class="display-value text-2xl" style="font-size: 2.2rem;">50</span>
                    <span class="unit">шт</span>
                </div>
                <input type="range" id="bluntCountRange" min="0" max="150" value="50">
            </div>

            <label class="custom-checkbox mt-2" onclick="triggerSplatter(event)">
                <input type="checkbox" id="fusionToggle">
                <span class="checkmark"></span>
                <span class="checkbox-label uppercase tracking-widest text-[0.65rem] font-bold">Сращивание (+50₽/шт)</span>
            </label>
            <div id="fusionControl" class="sub-control">
                <div class="flex items-baseline mt-2">
                    <span id="fusionCountVal" class="display-value text-2xl" style="font-size: 2.2rem;">50</span>
                    <span class="unit">шт</span>
                </div>
                <input type="range" id="fusionCountRange" min="0" max="150" value="50">
            </div>
        </div>

        <div id="groupAddonsCorrection" class="input-group hidden-element" style="border-bottom: none;">
            <span class="section-label">03. Доп. услуги</span>
            
            <label class="custom-checkbox" onclick="triggerSplatter(event)">
                <input type="checkbox" id="correctionLengthToggle">
                <span class="checkmark"></span>
                <span class="checkbox-label uppercase tracking-widest text-[0.65rem] font-bold">Коррекция длины (+50₽/10см)</span>
            </label>
            <div id="correctionLengthControl" class="sub-control">
                <div class="mb-4">
                    <span class="section-label" style="font-size: 0.5rem;">Количество дред</span>
                    <div class="flex items-baseline">
                        <span id="corrLengthCountVal" class="display-value text-2xl" style="font-size: 2.2rem;">50</span>
                        <span class="unit">шт</span>
                    </div>
                    <input type="range" id="corrLengthCountRange" min="0" max="150" value="50">
                </div>
                <div>
                    <span class="section-label" style="font-size: 0.5rem;">Длина коррекции</span>
                    <div class="flex items-baseline">
                        <span id="corrLengthCmVal" class="display-value text-2xl" style="font-size: 2.2rem;">10</span>
                        <span class="unit">см</span>
                    </div>
                    <input type="range" id="corrLengthCmRange" min="10" max="100" value="10" step="10">
                </div>
            </div>

            <label class="custom-checkbox mt-2" onclick="triggerSplatter(event)">
                <input type="checkbox" id="rootFeltingToggle">
                <span class="checkmark"></span>
                <span class="checkbox-label uppercase tracking-widest text-[0.65rem] font-bold">Прикорневое валяние (+30₽/шт)</span>
            </label>
            <div id="rootFeltingControl" class="sub-control">
                <div class="flex items-baseline mt-2">
                    <span id="rootFeltingCountVal" class="display-value text-2xl" style="font-size: 2.2rem;">50</span>
                    <span class="unit">шт</span>
                </div>
                <input type="range" id="rootFeltingCountRange" min="0" max="150" value="50">
            </div>
        </div>
    </main>

    <div class="result-panel">
        <span id="resultLabel" class="section-label">Итого</span>
        <div class="flex items-baseline">
            <span id="totalPrice" class="price-display">0</span>
            <span class="text-xl font-light ml-4 opacity-50">₽</span>
        </div>
    </div>

    <script>
        // --- VK Bridge Integration ---
        if (typeof vkBridge !== 'undefined') {
            vkBridge.send('VKWebAppInit');
        }

        // --- PWA Service Worker Registration ---
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js')
                    .then(reg => console.log('AfroPerm SW Registered', reg))
                    .catch(err => console.log('SW Registration failed', err));
            });
        }

        // --- Sound Engine ---
        let audioCtx;
        function playInteractionSound() {
            try {
                if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                const osc = audioCtx.createOscillator();
                const gain = audioCtx.createGain();
                osc.type = 'sine';
                osc.frequency.setValueAtTime(400, audioCtx.currentTime);
                osc.frequency.exponentialRampToValueAtTime(1200, audioCtx.currentTime + 0.04);
                gain.gain.setValueAtTime(0.2, audioCtx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.1);
                osc.connect(gain); gain.connect(audioCtx.destination);
                osc.start(); osc.stop(audioCtx.currentTime + 0.1);
            } catch (e) {}
        }

        // --- Splatter Particles ---
        const canvas = document.getElementById('splatterCanvas');
        const ctx = canvas.getContext('2d');
        let particles = [];

        function resizeCanvas() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
        }
        window.addEventListener('resize', resizeCanvas);
        resizeCanvas();

        class Particle {
            constructor(x, y) {
                this.x = x;
                this.y = y;
                this.size = Math.random() * 4 + 1;
                this.speedX = Math.random() * 6 - 3;
                this.speedY = Math.random() * 6 - 3;
                this.color = '#111827';
                this.opacity = 1;
            }
            update() {
                this.x += this.speedX;
                this.y += this.speedY;
                if (this.size > 0.1) this.size -= 0.1;
                this.opacity -= 0.02;
            }
            draw() {
                ctx.fillStyle = this.color;
                ctx.globalAlpha = this.opacity;
                ctx.beginPath();
                ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
                ctx.fill();
            }
        }

        function triggerSplatter(e) {
            const rect = e.currentTarget.getBoundingClientRect();
            const x = rect.left + rect.width / 2;
            const y = rect.top + rect.height / 2;
            for (let i = 0; i < 15; i++) {
                particles.push(new Particle(x, y));
            }
            playInteractionSound();
        }

        function animate() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            for (let i = 0; i < particles.length; i++) {
                particles[i].update();
                particles[i].draw();
                if (particles[i].opacity <= 0) {
                    particles.splice(i, 1);
                    i--;
                }
            }
            requestAnimationFrame(animate);
        }
        animate();

        // --- App Logic ---
        let currentService = 'creation';

        function toggleModal(show) {
            document.getElementById('modalOverlay').style.display = show ? 'block' : 'none';
            document.body.style.overflow = show ? 'hidden' : 'auto';
        }

        function setService(type, e) {
            currentService = type;
            document.getElementById('typeCreation').classList.toggle('active', type === 'creation');
            document.getElementById('typeCorrection').classList.toggle('active', type === 'correction');
            
            // Toggle groups
            document.getElementById('groupLength').classList.toggle('hidden-element', type === 'correction');
            document.getElementById('groupAddons').classList.toggle('hidden-element', type === 'correction');
            document.getElementById('groupAddonsCorrection').classList.toggle('hidden-element', type === 'creation');
            
            document.getElementById('mainCountLabel').innerText = type === 'creation' ? '01. Общее количество' : '01. Количество дред';
            
            triggerSplatter(e);
            calculateTotal();
        }

        // Listeners for UI updates
        const inputs = [
            'countRange', 'lengthRange', 'bluntCountRange', 'fusionCountRange',
            'corrLengthCountRange', 'corrLengthCmRange', 'rootFeltingCountRange',
            'bluntEndToggle', 'fusionToggle', 'correctionLengthToggle', 'rootFeltingToggle'
        ];

        inputs.forEach(id => {
            const el = document.getElementById(id);
            el.addEventListener('input', () => {
                updateUI();
                calculateTotal();
            });
        });

        function updateUI() {
            document.getElementById('countVal').innerText = document.getElementById('countRange').value;
            document.getElementById('lengthVal').innerText = document.getElementById('lengthRange').value;
            document.getElementById('bluntCountVal').innerText = document.getElementById('bluntCountRange').value;
            document.getElementById('fusionCountVal').innerText = document.getElementById('fusionCountRange').value;
            document.getElementById('corrLengthCountVal').innerText = document.getElementById('corrLengthCountRange').value;
            document.getElementById('corrLengthCmVal').innerText = document.getElementById('corrLengthCmRange').value;
            document.getElementById('rootFeltingCountVal').innerText = document.getElementById('rootFeltingCountRange').value;

            // Sub-controls visibility
            document.getElementById('bluntEndControl').classList.toggle('active', document.getElementById('bluntEndToggle').checked);
            document.getElementById('fusionControl').classList.toggle('active', document.getElementById('fusionToggle').checked);
            document.getElementById('correctionLengthControl').classList.toggle('active', document.getElementById('correctionLengthToggle').checked);
            document.getElementById('rootFeltingControl').classList.toggle('active', document.getElementById('rootFeltingToggle').checked);
        }

        function calculateTotal() {
            let total = 0;
            const count = parseInt(document.getElementById('countRange').value);

            if (currentService === 'creation') {
                const len = parseInt(document.getElementById('lengthRange').value);
                let pricePerUnit = 300;
                if (len > 30) pricePerUnit = 900 + (Math.floor((len - 40) / 10) + 1) * 200;
                else if (len > 20) pricePerUnit = 700;
                else if (len > 10) pricePerUnit = 500;

                total = count * pricePerUnit;

                if (document.getElementById('bluntEndToggle').checked) {
                    total += parseInt(document.getElementById('bluntCountRange').value) * 50;
                }
                if (document.getElementById('fusionToggle').checked) {
                    total += parseInt(document.getElementById('fusionCountRange').value) * 50;
                }
            } else {
                // Correction
                total = count * 150;
                if (document.getElementById('correctionLengthToggle').checked) {
                    const cCount = parseInt(document.getElementById('corrLengthCountRange').value);
                    const cLen = parseInt(document.getElementById('corrLengthCmRange').value);
                    total += cCount * (cLen / 10 * 50);
                }
                if (document.getElementById('rootFeltingToggle').checked) {
                    total += parseInt(document.getElementById('rootFeltingCountRange').value) * 30;
                }
            }

            // Animate total
            const display = document.getElementById('totalPrice');
            const start = parseInt(display.innerText);
            const duration = 400;
            const startTime = performance.now();

            function updatePrice(currentTime) {
                const elapsed = currentTime - startTime;
                const progress = Math.min(elapsed / duration, 1);
                const current = Math.floor(start + (total - start) * progress);
                display.innerText = current.toLocaleString();
                if (progress < 1) requestAnimationFrame(updatePrice);
            }
            requestAnimationFrame(updatePrice);
        }

        updateUI();
        calculateTotal();
    </script>
</body>
</html>

